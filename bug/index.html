<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bug Report Trainer</title>
  <meta name="theme-color" content="#071221" />

  <style>
    :root{
      --bg0:#050914;
      --bg1:#071221;
      --text:#EAF2FF;
      --muted2:rgba(234,242,255,.55);
      --accent:#59C3FF;
      --good:#3CE07A;
      --warn:#FFD166;
      --bad:#FF5C7A;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:100%;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(89,195,255,.20), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(75,227,209,.14), transparent 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(255,92,122,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    *{ caret-color: transparent; }
    textarea, input, select{ caret-color: var(--text); }

    .wrap{
      max-width: 680px;
      margin: 0 auto;
      padding: 24px 14px;
      min-height: 100svh;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .card{
      width: 100%;
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
    }

    .cardHead{ display:none; }
    .cardBody{ padding: 0; }
    .hidden{ display:none !important; }

    #panelInput{ user-select: none; }
    #panelInput textarea, #panelInput input, #panelInput select{ user-select: text; }

    .q{
      padding: 6px 0;
      margin-bottom: 14px;
      background: none;
      border: none;
    }

    .q label{
      display:flex;
      gap:10px;
      align-items:center;
      color: rgba(234,242,255,.90);
      font-size: 13px;
      margin-bottom: 8px;
      user-select:none;
      cursor: default;
    }

    .n{
      width: 22px; height: 22px;
      border-radius: 8px;
      display:grid; place-items:center;
      background: rgba(89,195,255,.14);
      border: 1px solid rgba(89,195,255,.22);
      color: rgba(234,242,255,.92);
      font-size: 12px;
      flex: 0 0 auto;
      user-select:none;
      cursor: default;
    }

    textarea, input, select{
      width:100%;
      background: rgba(234,242,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 11px;
      outline: none;
      font-size: 14px;
      line-height: 1.35;
    }

    textarea{ min-height: 54px; resize: vertical; }

    textarea:focus, input:focus, select:focus{
      border-color: rgba(89,195,255,.38);
      box-shadow: 0 0 0 4px rgba(89,195,255,.10);
    }

    select{
      background-color: rgba(234,242,255,.06);
      color: rgba(234,242,255,.92);
    }
    select option{
      background-color: #0b162e;
      color: #eaf2ff;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width:520px){ .row{ grid-template-columns: 1fr; } }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
      justify-content:flex-start;
    }
    .btnRow.split{ justify-content:space-between; }

    .btnGroup{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btnGroup.right{ justify-content:flex-end; }

    .btn{
      border:1px solid rgba(89,195,255,.25);
      color: rgba(234,242,255,.92);
      background: rgba(89,195,255,.10);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      letter-spacing:.15px;
      transition: transform .08s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(89,195,255,.30), rgba(89,195,255,.14));
      border-color: rgba(89,195,255,.40);
      box-shadow: 0 14px 40px rgba(89,195,255,.10);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(234,242,255,.12);
      color: rgba(234,242,255,.75);
    }
    .btn.danger{
      background: rgba(255,92,122,.10);
      border-color: rgba(255,92,122,.25);
      color: rgba(234,242,255,.88);
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; filter:none; transform:none; }

    .btn.back{
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      background: rgba(234,242,255,.06);
      border-color: rgba(234,242,255,.12);
      color: rgba(234,242,255,.86);
    }

    .iconBtn{
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 6px 8px;
      border-radius: 10px;
      color: rgba(234,242,255,.92);
      cursor:pointer;
      font-size: 16px;
      line-height: 1;
      user-select:none;
      transition: transform .08s ease, opacity .12s ease;
    }
    .iconBtn:hover{ opacity: .92; }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:focus{ outline: none; }
    .iconBtn:focus-visible{ outline: 2px solid rgba(89,195,255,.35); outline-offset: 2px; }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-bottom:12px;
    }
    .segBtn{
      border:1px solid rgba(234,242,255,.12);
      background: rgba(234,242,255,.06);
      color: rgba(234,242,255,.80);
      padding: 7px 9px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 12.5px;
      user-select:none;
      transition: filter .12s ease, transform .08s ease, background .12s ease, border-color .12s ease;
      white-space: nowrap;
    }
    .segBtn:hover{ filter: brightness(1.06); }
    .segBtn:active{ transform: translateY(1px); }
    .segBtn.active{
      border-color: rgba(89,195,255,.35);
      background: rgba(89,195,255,.12);
      color: rgba(234,242,255,.92);
    }

    .outBlock{
      padding: 12px 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(5,9,20,.18);
      margin-bottom: 10px;
    }

    .outTitle{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 0 0 10px;
      font-size: 13px;
      color: rgba(234,242,255,.92);
      letter-spacing:.2px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(89,195,255,.12);
      flex: 0 0 auto;
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 4px rgba(60,224,122,.10); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(255,209,102,.10); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(255,92,122,.10); }

    pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(234,242,255,.92);
    }

    .small{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
      margin-top: 8px;
      user-select:none;
      cursor: default;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,20,43,.92);
      border: 1px solid rgba(89,195,255,.20);
      color: rgba(234,242,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 99;
      max-width: min(520px, calc(100vw - 24px));
      text-align:center;
      font-size: 13px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    .wizardShell{ display:flex; flex-direction:column; gap:8px; }
    #wizardMode .q{ margin-bottom: 8px; }
    #wizardMode .btnRow{ margin-top: 6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="card" id="mainCard">
      <div class="cardHead hidden" id="cardHead">
        <button class="btn back" id="backBtn" type="button" title="–ù–∞–∑–∞–¥" aria-label="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</button>
      </div>

      <div class="cardBody">

        <div id="panelInput">

          <div id="formMode">
            <div class="q" id="q1Block">
              <label><span class="n" id="n1">1</span> <span id="l1">–®–∞–≥–∏ / –¥–µ–π—Å—Ç–≤–∏—è</span></label>
              <textarea id="q1"></textarea>
            </div>

            <div class="q" id="q2Block">
              <label><span class="n" id="n2">2</span> <span id="l2">–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å?</span></label>
              <textarea id="q2"></textarea>
            </div>

            <div class="q" id="q3Block">
              <label><span class="n" id="n3">3</span> <span id="l3">–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?</span></label>
              <textarea id="q3"></textarea>
            </div>

            <div class="row">
              <div class="q" style="margin:0;" id="q4Block">
                <label><span class="n" id="n4">4</span> <span id="l4">–ì–¥–µ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?</span></label>
                <input id="q4" />
              </div>

              <div class="q" style="margin:0;" id="q5Block">
                <label><span class="n" id="n5">5</span> <span id="l5">–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?</span></label>
                <select id="q5">
                  <option value="Low">–ù–∏–∑–∫–æ</option>
                  <option value="Medium" selected>–°—Ä–µ–¥–Ω–µ</option>
                  <option value="High">–í—ã—Å–æ–∫–æ</option>
                  <option value="Critical">–ö—Ä–∏—Ç–∏—á–Ω–æ</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="q" style="margin:0;" id="envBlock">
                <label><span class="n" id="n6">6</span> <span id="l6">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / –≤–µ—Ä—Å–∏—è</span></label>
                <input id="env" />
              </div>

              <div class="q" style="margin:0;" id="typeBlock">
                <label><span class="n" id="n7">7</span> <span id="l7">–¢–∏–ø –±–∞–≥–∞</span></label>
                <select id="type">
                  <option value="functional" selected>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                  <option value="ui">UI/–î–∏–∑–∞–π–Ω</option>
                  <option value="typo">–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è/–¢–µ–∫—Å—Ç</option>
                  <option value="crash">–ö—Ä–∞—à/–ó–∞–≤–∏—Å–∞–Ω–∏–µ</option>
                </select>
              </div>
            </div>

            <div class="btnRow split">
              <div class="btnGroup">
                <button class="btn primary" id="genForm" type="button" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn" id="newReport" type="button" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</button>
              </div>

              <div class="btnGroup right">
                <button class="iconBtn" id="reportModeBtn" type="button"
                  title="–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: —É–≤–∏–¥–µ–Ω–æ / –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª(–∞)" aria-label="–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: —É–≤–∏–¥–µ–Ω–æ / –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª(–∞)">üëÅÔ∏è</button>

                <button class="iconBtn" id="toggleInputModeBtn" type="button"
                  title="–†–µ–∂–∏–º –≤–≤–æ–¥–∞: —Ñ–æ—Ä–º–∞ / –ø–æ —à–∞–≥–∞–º" aria-label="–†–µ–∂–∏–º –≤–≤–æ–¥–∞: —Ñ–æ—Ä–º–∞ / –ø–æ —à–∞–≥–∞–º">‚áÑ</button>

                <button class="iconBtn" id="demo" type="button"
                  title="–î–µ–º–æ: –∑–∞–ø–æ–ª–Ω–∏—Ç—å / –æ—á–∏—Å—Ç–∏—Ç—å" aria-label="–î–µ–º–æ: –∑–∞–ø–æ–ª–Ω–∏—Ç—å / –æ—á–∏—Å—Ç–∏—Ç—å">?</button>
              </div>
            </div>
          </div>

          <div id="wizardMode" class="hidden">
            <div class="wizardShell">
              <div class="q" id="wizBox">
                <label id="wizLabel"><span class="n" id="wizN">1</span> ‚Äî</label>
                <div id="wizField"></div>
              </div>

              <div class="btnRow split">
                <div class="btnGroup">
                  <button class="btn ghost" id="wizBack" type="button" title="–ù–∞–∑–∞–¥" aria-label="–ù–∞–∑–∞–¥">–ù–∞–∑–∞–¥</button>
                  <button class="btn primary" id="wizNext" type="button" title="–î–∞–ª–µ–µ" aria-label="–î–∞–ª–µ–µ">–î–∞–ª–µ–µ</button>
                  <button class="btn primary hidden" id="wizGen" type="button" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn" id="newReport2" type="button" title="–û—á–∏—Å—Ç–∏—Ç—å" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</button>
                </div>

                <div class="btnGroup right">
                  <button class="iconBtn" id="reportModeBtn2" type="button"
                    title="–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: —É–≤–∏–¥–µ–Ω–æ / –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª(–∞)" aria-label="–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: —É–≤–∏–¥–µ–Ω–æ / –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª(–∞)">üëÅÔ∏è</button>

                  <button class="iconBtn" id="toggleInputModeBtn2" type="button"
                    title="–†–µ–∂–∏–º –≤–≤–æ–¥–∞: —Ñ–æ—Ä–º–∞ / –ø–æ —à–∞–≥–∞–º" aria-label="–†–µ–∂–∏–º –≤–≤–æ–¥–∞: —Ñ–æ—Ä–º–∞ / –ø–æ —à–∞–≥–∞–º">‚áÑ</button>

                  <button class="iconBtn" id="demo2" type="button"
                    title="–î–µ–º–æ: –∑–∞–ø–æ–ª–Ω–∏—Ç—å / –æ—á–∏—Å—Ç–∏—Ç—å" aria-label="–î–µ–º–æ: –∑–∞–ø–æ–ª–Ω–∏—Ç—å / –æ—á–∏—Å—Ç–∏—Ç—å">?</button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div id="panelResult" class="hidden">
          <div class="seg">
            <button class="segBtn active" id="showEN" type="button" title="–ü–æ–∫–∞–∑–∞—Ç—å EN" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å EN">EN</button>
            <button class="segBtn" id="showRU" type="button" title="–ü–æ–∫–∞–∑–∞—Ç—å RU" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å RU">RU</button>
          </div>

          <div class="outBlock" id="blockEN">
            <div class="outTitle">
              <span style="display:flex; align-items:center; gap:10px;"><span class="dot"></span> Bug Report (EN)</span>
              <span class="small" id="sevPill">‚Äî</span>
            </div>
            <pre id="outEN">‚Äî</pre>
          </div>

          <div class="outBlock hidden" id="blockRU">
            <div class="outTitle">
              <span style="display:flex; align-items:center; gap:10px;"><span class="dot good"></span> –ü–µ—Ä–µ–≤–æ–¥ (RU)</span>
              <span class="small" id="envPill">‚Äî</span>
            </div>
            <pre id="outRU">‚Äî</pre>
          </div>

          <div class="outBlock" id="blockAfter">
            <div class="outTitle">
              <span style="display:flex; align-items:center; gap:10px;"><span class="dot warn"></span> –°–ª–æ–≤–∞—Ä—å</span>
            </div>
            <div class="small" id="afterText">‚Äî</div>

            <div class="btnRow">
              <button class="btn primary" id="goVocab" type="button" title="–û—Ç–∫—Ä—ã—Ç—å —Å–ª–æ–≤–∞—Ä—å" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Å–ª–æ–≤–∞—Ä—å">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Å–ª–æ–≤–∞—Ä—å</button>
              <button class="btn" id="newReport3" type="button" title="–û—á–∏—Å—Ç–∏—Ç—å" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</button>
            </div>
          </div>
        </div>

        <div id="panelVocab" class="hidden">
          <div class="outBlock">
            <div class="outTitle">
              <span style="display:flex; align-items:center; gap:10px;"><span class="dot warn"></span> –ù–æ–≤—ã–µ (—ç—Ç–æ—Ç –æ—Ç—á—ë—Ç)</span>
              <span class="small" id="vocNewCountPill">0</span>
            </div>
            <pre id="outVNew">‚Äî</pre>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn primary" id="sendToVocZen" type="button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ VocZen (–†–µ–∑–µ—Ä–≤ ‚Üí –°–ª–æ–≤–∞)" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ VocZen (–†–µ–∑–µ—Ä–≤ ‚Üí –°–ª–æ–≤–∞)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ VocZen</button>
              <button class="btn" id="copyNew" type="button" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ">Copy</button>
              <button class="btn danger" id="clearNew" type="button" title="–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö (—Ç–æ–ª—å–∫–æ —Ç—É—Ç)" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö (—Ç–æ–ª—å–∫–æ —Ç—É—Ç)">–û—á–∏—Å—Ç–∏—Ç—å</button>
              <button class="btn" id="newReport4" type="button" title="–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç" aria-label="–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç">–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç</button>
            </div>

            <div class="small" style="margin-top:10px;">
              –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä—ã –≤ VocZen ‚Üí –†–µ–∑–µ—Ä–≤ ‚Üí –°–ª–æ–≤–∞ (–±–µ–∑ –¥—É–±–ª–µ–π).
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <div class="toast" id="toast">OK</div>

<script>
  // ========= CONFIG =========
  const AI_ENDPOINT = "https://bold-dream-f448.kuzsam15.workers.dev";
  const APP_TOKEN = "";

  // ========= VocZen storage key (–°–õ–û–í–ê ‚Üí –†–ï–ó–ï–†–í) =========
  const VZ_WORDS_VAULT_KEY = "vz_words_vault_v1";

  // ========= utils =========
  const $ = (id) => document.getElementById(id);
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }
  function cleanSpaces(s){ return (s||"").replace(/\s+/g," ").trim(); }
  function normKey(s){ return String(s||"").replace(/\s+/g," ").trim().toLowerCase(); }

  function dedupePairs(pairs){
    const seen = new Set();
    const out = [];
    for(const p of (pairs || [])){
      if(!p) continue;
      const a = cleanSpaces(p.a);
      const b = cleanSpaces(p.b);
      if(!a || !b) continue;
      const k = normKey(a) + "||" + normKey(b);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push({a,b});
    }
    return out;
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      const v = JSON.parse(raw);
      return v ?? fallback;
    }catch{
      return fallback;
    }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // ========= state =========
  const state = {
    tab: "input",
    inputMode: "form",
    wizardStep: 0,
    reportMode: "observe",
    demoOn: false,
    lastNewVocab: [],
  };

  // ========= panels =========
  const panels = {
    input: $("panelInput"),
    result: $("panelResult"),
    vocab: $("panelVocab")
  };

  function setTab(name){
    state.tab = name;
    Object.entries(panels).forEach(([k, el])=>{
      el.classList.toggle("hidden", k !== name);
    });
    $("cardHead").classList.toggle("hidden", name === "input");
    if(name === "vocab") renderVocabPanel();
    if(name === "input") focusFirstInput();
  }

  function focusFirstInput(){
    if(state.inputMode === "form"){
      if(state.reportMode === "observe") $("q2").focus();
      else $("q1").focus();
    }else{
      wizardFocus();
    }
  }

  $("backBtn").addEventListener("click", ()=>{
    if(state.tab === "vocab") setTab("result");
    else setTab("input");
  });

  function setInputMode(mode){
    state.inputMode = mode;
    const isForm = mode === "form";
    $("formMode").classList.toggle("hidden", !isForm);
    $("wizardMode").classList.toggle("hidden", isForm);
    if(!isForm){
      state.wizardStep = Math.min(state.wizardStep, getWizardSteps().length - 1);
      renderWizard();
      wizardFocus();
    }else{
      focusFirstInput();
    }
  }
  function toggleInputMode(){
    setInputMode(state.inputMode === "form" ? "wizard" : "form");
    toast(state.inputMode === "form" ? "–§–æ—Ä–º–∞" : "–ü–æ —à–∞–≥–∞–º");
  }
  $("toggleInputModeBtn").addEventListener("click", toggleInputMode);
  $("toggleInputModeBtn2").addEventListener("click", toggleInputMode);

  function renderReportModeUI(){
    const isInteract = state.reportMode === "interact";
    const icon = isInteract ? "üñ•Ô∏è" : "üëÅÔ∏è";
    $("reportModeBtn").textContent = icon;
    $("reportModeBtn2").textContent = icon;

    const title = isInteract
      ? "–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª(–∞) ‚Äî –µ—Å—Ç—å —à–∞–≥–∏"
      : "–†–µ–∂–∏–º —Ä–µ–ø–æ—Ä—Ç–∞: —É–≤–∏–¥–µ–Ω–æ ‚Äî –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π";
    $("reportModeBtn").title = title;
    $("reportModeBtn2").title = title;
    $("reportModeBtn").setAttribute("aria-label", title);
    $("reportModeBtn2").setAttribute("aria-label", title);

    applyQuestionLayout();
    if(state.inputMode === "wizard"){
      state.wizardStep = 0;
      renderWizard();
    }
  }

  function toggleReportMode(){
    state.reportMode = (state.reportMode === "observe") ? "interact" : "observe";
    renderReportModeUI();
    focusFirstInput();
  }

  $("reportModeBtn").addEventListener("click", toggleReportMode);
  $("reportModeBtn2").addEventListener("click", toggleReportMode);

  function applyQuestionLayout(){
    const observe = state.reportMode === "observe";
    $("q1Block").classList.toggle("hidden", observe);

    const map = observe
      ? {
          n2:"1", l2:"–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å?",
          n3:"2", l3:"–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?",
          n4:"3", l4:"–ì–¥–µ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?",
          n5:"4", l5:"–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?",
          n6:"5", l6:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / –≤–µ—Ä—Å–∏—è",
          n7:"6", l7:"–¢–∏–ø –±–∞–≥–∞"
        }
      : {
          n1:"1", l1:"–®–∞–≥–∏ / –¥–µ–π—Å—Ç–≤–∏—è",
          n2:"2", l2:"–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å?",
          n3:"3", l3:"–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?",
          n4:"4", l4:"–ì–¥–µ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?",
          n5:"5", l5:"–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?",
          n6:"6", l6:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / –≤–µ—Ä—Å–∏—è",
          n7:"7", l7:"–¢–∏–ø –±–∞–≥–∞"
        };

    for(const [id,val] of Object.entries(map)){
      const el = $(id);
      if(el) el.textContent = val;
    }
  }

  function setResultView(which){
    const en = (which === "en");
    $("showEN").classList.toggle("active", en);
    $("showRU").classList.toggle("active", !en);
    $("blockEN").classList.toggle("hidden", !en);
    $("blockRU").classList.toggle("hidden", en);
  }
  $("showEN").addEventListener("click", ()=>setResultView("en"));
  $("showRU").addEventListener("click", ()=>setResultView("ru"));

  function gatherInputs(){
    return {
      mode: state.reportMode,
      type: $("type").value,
      severity: $("q5").value,
      location_ru: cleanSpaces($("q4").value),
      env_text: cleanSpaces($("env").value),
      q1: cleanSpaces($("q1").value),
      q2: cleanSpaces($("q2").value),
      q3: cleanSpaces($("q3").value),
    };
  }

  function validateInputs(data){
    if(!data.q2 || !data.q3){
      toast("–ó–∞–ø–æ–ª–Ω–∏: —á—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å + –∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å");
      return false;
    }
    return true;
  }

  function demo(){
    state.demoOn = !state.demoOn;

    if(state.demoOn){
      if(state.reportMode === "observe"){
        $("q2").value = '–ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "Sign in" –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ —Å—ä–µ–∑–∂–∞–µ—Ç.';
        $("q3").value = '–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—Ä–æ–≤–Ω–µ–Ω –∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è.';
      }else{
        $("q1").value = '–û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "Sign in".';
        $("q2").value = "–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–ª–æ.";
        $("q3").value = "–î–æ–ª–∂–Ω–æ –±—ã–ª–æ –ø–æ—è–≤–∏—Ç—å—Å—è –æ–∫–Ω–æ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è.";
      }
      $("q4").value = "–Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ";
      $("q5").value = "High";
      $("env").value = "iPhone 13, iOS 18.2, App v1.2.0";
      $("type").value = (state.reportMode === "observe") ? "ui" : "crash";
      toast("–î–µ–º–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ");
    }else{
      $("q1").value = "";
      $("q2").value = "";
      $("q3").value = "";
      $("q4").value = "";
      $("env").value = "";
      $("q5").value = "Medium";
      $("type").value = "functional";
      toast("–î–µ–º–æ –æ—á–∏—â–µ–Ω–æ");
    }

    if(state.inputMode === "wizard"){
      state.wizardStep = 0;
      renderWizard();
      wizardFocus();
    }else{
      focusFirstInput();
    }
  }
  $("demo").addEventListener("click", demo);
  $("demo2").addEventListener("click", demo);

  function setLoading(isLoading){
    $("genForm").disabled = isLoading;
    $("newReport").disabled = isLoading;
    if($("wizGen")) $("wizGen").disabled = isLoading;
  }

  async function generateAI(){
    const data = gatherInputs();
    if(!validateInputs(data)) return;

    if(!AI_ENDPOINT || AI_ENDPOINT.includes("YOUR-WORKER")){
      toast("–°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å AI_ENDPOINT (URL Worker)");
      return;
    }

    setLoading(true);
    $("outEN").textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶";
    $("outRU").textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶";
    $("sevPill").textContent = `Severity: ${data.severity}`;
    $("envPill").textContent = data.env_text ? `Env: ${data.env_text}` : "Env: ‚Äî";

    try{
      const resp = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...(APP_TOKEN ? {"Authorization": `Bearer ${APP_TOKEN}`} : {})
        },
        body: JSON.stringify(data)
      });

      const json = await resp.json().catch(()=> ({}));
      if(!resp.ok){
        const msg = json && (json.error || json.detail)
          ? (json.error + (json.detail ? (": " + json.detail) : ""))
          : "–û—à–∏–±–∫–∞ AI";
        $("outEN").textContent = "‚Äî";
        $("outRU").textContent = "‚Äî";
        toast(msg.slice(0,120));
        setTab("result");
        setResultView("en");
        return;
      }

      const en = (json.en_report || "‚Äî").trim();
      const ru = (json.ru_report || "‚Äî").trim();
      const newVocab = Array.isArray(json.new_vocab) ? json.new_vocab : [];

      $("outEN").textContent = en || "‚Äî";
      $("outRU").textContent = ru || "‚Äî";

      state.lastNewVocab = newVocab
        .filter(x=>x && x.en && x.ru)
        .slice(0,15)
        .map(x=>({ en: cleanSpaces(x.en), ru: cleanSpaces(x.ru) }))
        .filter(x=>x.en && x.ru);

      $("afterText").textContent = state.lastNewVocab.length
        ? `–ù–æ–≤—ã—Ö –¥–ª—è —Å–ª–æ–≤–∞—Ä—è: ${state.lastNewVocab.length}.`
        : `–ù–æ–≤—ã—Ö –¥–ª—è —Å–ª–æ–≤–∞—Ä—è –Ω–µ—Ç.`;

      setTab("result");
      setResultView("en");
      toast("–ì–æ—Ç–æ–≤–æ");
    }catch(err){
      $("outEN").textContent = "‚Äî";
      $("outRU").textContent = "‚Äî";
      toast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / Worker");
      setTab("result");
      setResultView("en");
    }finally{
      setLoading(false);
    }
  }

  $("genForm").addEventListener("click", generateAI);

  function renderVocabPanel(){
    const newLines = (state.lastNewVocab || []).map(x => `${x.en} ‚Äî ${x.ru}`);

    $("vocNewCountPill").textContent = String(newLines.length);
    $("outVNew").textContent = newLines.length ? newLines.join("\n") : "‚Äî";

    $("copyNew").disabled = !newLines.length;
    $("sendToVocZen").disabled = !newLines.length;
    $("clearNew").disabled = !newLines.length;
  }

  function newReport(){
    $("q1").value = "";
    $("q2").value = "";
    $("q3").value = "";
    $("q4").value = "";
    $("env").value = "";
    $("q5").value = "Medium";
    $("type").value = "functional";

    state.demoOn = false;
    state.lastNewVocab = [];

    if(state.inputMode === "wizard"){
      state.wizardStep = 0;
      renderWizard();
    }

    setTab("input");
    focusFirstInput();
    toast("–ù–æ–≤—ã–π –æ—Ç—á—ë—Ç");
  }

  async function copyText(text){
    const t = (text || "").trim();
    if(!t){ toast("–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"); return; }
    try{
      await navigator.clipboard.writeText(t);
      toast("Copied");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toast("Copied");
    }
  }

  function sendNewToVocZen(){
    const items = (state.lastNewVocab || [])
      .filter(x=>x && x.en && x.ru)
      .map(x=>({ a: cleanSpaces(x.en), b: cleanSpaces(x.ru) }))
      .filter(x=>x.a && x.b);

    if(!items.length){
      toast("–ù–µ—á–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å");
      return;
    }

    // –≥—Ä—É–∑–∏–º —Ç–µ–∫—É—â–∏–π VocZen vault (—Å–ª–æ–≤–∞)
    const current = loadJSON(VZ_WORDS_VAULT_KEY, []);
    const currentPairs = Array.isArray(current) ? current : [];

    const before = currentPairs.length;

    // –º–µ—Ä–¥–∂ + –¥–µ–¥—É–ø
    const merged = dedupePairs(currentPairs.concat(items));

    saveJSON(VZ_WORDS_VAULT_KEY, merged);

    const after = merged.length;
    const added = Math.max(0, after - before);

    toast(added ? `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: +${added}` : "–£–∂–µ –µ—Å—Ç—å (–¥—É–±–ª–µ–π –Ω–µ—Ç)");

    // —á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ ‚Äî –æ—á–∏—â–∞–µ–º ‚Äú–Ω–æ–≤—ã–µ —ç—Ç–æ–≥–æ –æ—Ç—á—ë—Ç–∞‚Äù
    state.lastNewVocab = [];
    if(state.tab === "vocab") renderVocabPanel();
  }

  $("goVocab").addEventListener("click", ()=>setTab("vocab"));

  ["newReport","newReport2","newReport3","newReport4"].forEach(id=>{
    $(id).addEventListener("click", newReport);
  });

  $("copyNew").addEventListener("click", ()=>{
    const newText = (state.lastNewVocab || []).map(x => `${x.en} ‚Äî ${x.ru}`).join("\n");
    copyText(newText);
  });

  $("sendToVocZen").addEventListener("click", sendNewToVocZen);

  $("clearNew").addEventListener("click", ()=>{
    state.lastNewVocab = [];
    renderVocabPanel();
    toast("–û—á–∏—â–µ–Ω–æ");
  });

  function getWizardSteps(){
    if(state.reportMode === "observe"){
      return [
        { key:"q2", label:"–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å?", type:"textarea" },
        { key:"q3", label:"–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?", type:"textarea" },
        { key:"q4", label:"–ì–¥–µ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?", type:"input" },
        { key:"q5", label:"–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?", type:"select",
          options:[ ["Low","–ù–∏–∑–∫–æ"], ["Medium","–°—Ä–µ–¥–Ω–µ"], ["High","–í—ã—Å–æ–∫–æ"], ["Critical","–ö—Ä–∏—Ç–∏—á–Ω–æ"] ] },
        { key:"env", label:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / –≤–µ—Ä—Å–∏—è", type:"input" },
        { key:"type", label:"–¢–∏–ø –±–∞–≥–∞", type:"select",
          options:[ ["functional","–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π"], ["ui","UI/–î–∏–∑–∞–π–Ω"], ["typo","–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è/–¢–µ–∫—Å—Ç"], ["crash","–ö—Ä–∞—à/–ó–∞–≤–∏—Å–∞–Ω–∏–µ"] ] }
      ];
    }
    return [
      { key:"q1", label:"–®–∞–≥–∏ / –¥–µ–π—Å—Ç–≤–∏—è", type:"textarea" },
      { key:"q2", label:"–ß—Ç–æ –Ω–µ —Ç–∞–∫ —Å–µ–π—á–∞—Å?", type:"textarea" },
      { key:"q3", label:"–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?", type:"textarea" },
      { key:"q4", label:"–ì–¥–µ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?", type:"input" },
      { key:"q5", label:"–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?", type:"select",
        options:[ ["Low","–ù–∏–∑–∫–æ"], ["Medium","–°—Ä–µ–¥–Ω–µ"], ["High","–í—ã—Å–æ–∫–æ"], ["Critical","–ö—Ä–∏—Ç–∏—á–Ω–æ"] ] },
      { key:"env", label:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ / –≤–µ—Ä—Å–∏—è", type:"input" },
      { key:"type", label:"–¢–∏–ø –±–∞–≥–∞", type:"select",
        options:[ ["functional","–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π"], ["ui","UI/–î–∏–∑–∞–π–Ω"], ["typo","–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è/–¢–µ–∫—Å—Ç"], ["crash","–ö—Ä–∞—à/–ó–∞–≤–∏—Å–∞–Ω–∏–µ"] ] }
    ];
  }

  function renderWizard(){
    const steps = getWizardSteps();
    const idx = Math.max(0, Math.min(state.wizardStep, steps.length - 1));
    state.wizardStep = idx;
    const step = steps[idx];

    $("wizLabel").innerHTML = `<span class="n" id="wizN">${idx+1}</span> ${step.label}`;

    const host = $("wizField");
    host.innerHTML = "";

    let el;
    if(step.type === "textarea"){
      el = document.createElement("textarea");
      el.value = $(step.key).value;
      el.addEventListener("input", ()=>{ $(step.key).value = el.value; });
    }else if(step.type === "input"){
      el = document.createElement("input");
      el.value = $(step.key).value;
      el.addEventListener("input", ()=>{ $(step.key).value = el.value; });
    }else if(step.type === "select"){
      el = document.createElement("select");
      step.options.forEach(([val, txt])=>{
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = txt;
        el.appendChild(opt);
      });
      el.value = $(step.key).value;
      el.addEventListener("change", ()=>{ $(step.key).value = el.value; });
    }

    el.id = "wizActiveField";
    host.appendChild(el);

    $("wizBack").disabled = (idx === 0);
    const last = (idx === steps.length - 1);
    $("wizNext").classList.toggle("hidden", last);
    $("wizGen").classList.toggle("hidden", !last);

    el.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      if(step.type === "textarea" && e.shiftKey) return;
      e.preventDefault();
      if(last) generateAI();
      else wizardNext();
    });
  }

  function wizardFocus(){
    const el = $("wizActiveField");
    if(el) el.focus();
  }

  function wizardNext(){
    const steps = getWizardSteps();
    if(state.wizardStep < steps.length - 1){
      state.wizardStep += 1;
      renderWizard();
      wizardFocus();
    }
  }
  function wizardBack(){
    if(state.wizardStep > 0){
      state.wizardStep -= 1;
      renderWizard();
      wizardFocus();
    }
  }

  $("wizNext").addEventListener("click", wizardNext);
  $("wizBack").addEventListener("click", wizardBack);
  $("wizGen").addEventListener("click", generateAI);

  applyQuestionLayout();
  renderReportModeUI();
  setTab("input");
  setInputMode("form");
  $("sevPill").textContent = "‚Äî";
  $("envPill").textContent = "Env: ‚Äî";
</script>
</body>
</html>
